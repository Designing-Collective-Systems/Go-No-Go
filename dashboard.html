<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go/No-Go Results Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Sora:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Sora', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        .phase-toggle {
            display: inline-flex;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 4px;
        }
        
        .phase-toggle button {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .phase-toggle button.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1e293b;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: white;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>Loading data...</div>
    </div>
    
    <div id="dashboard" class="hidden max-w-7xl mx-auto p-8">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-white mb-4">Go/No-Go Results Dashboard</h1>
            <p class="text-xl text-white/90">Comprehensive analysis of your task performance</p>
        </div>
        
        <!-- Phase Selection -->
        <div class="card text-center">
            <div class="phase-toggle">
                <button id="btn-practice" onclick="setPhase('practice')">Practice</button>
                <button id="btn-real" onclick="setPhase('real')">Real Study</button>
                <button id="btn-both" onclick="setPhase('both')" class="active">Both</button>
            </div>
        </div>
        
        <!-- Summary Statistics -->
        <div class="card">
            <h2 class="section-title">Summary Statistics</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card">
                    <div class="text-3xl font-bold mono" id="stat-total-trials">-</div>
                    <div class="text-sm opacity-90 mt-1">Total Trials</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold mono" id="stat-accuracy">-</div>
                    <div class="text-sm opacity-90 mt-1">Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold mono" id="stat-mean-rt">-</div>
                    <div class="text-sm opacity-90 mt-1">Mean RT (ms)</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold mono" id="stat-median-rt">-</div>
                    <div class="text-sm opacity-90 mt-1">Median RT (ms)</div>
                </div>
            </div>
        </div>
        
        <!-- Reaction Time Analysis -->
        <div class="card">
            <h2 class="section-title">Reaction Time Analysis</h2>
            <div id="rt-histogram" style="height: 400px;"></div>
        </div>
        
        <div class="card">
            <h2 class="section-title">Reaction Time Distribution</h2>
            <div id="rt-boxplot" style="height: 300px;"></div>
        </div>
        
        <div class="card">
            <h2 class="section-title">Reaction Time by Trial</h2>
            <div id="rt-by-trial" style="height: 350px;"></div>
        </div>
        
        <!-- Error Analysis -->
        <div class="card">
            <h2 class="section-title">Error Analysis</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold mb-3 text-lg">Error Types</h3>
                    <div id="error-types" style="height: 300px;"></div>
                </div>
                <div>
                    <h3 class="font-semibold mb-3 text-lg">Errors by Trial</h3>
                    <div id="errors-by-trial" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Additional Metrics -->
        <div class="card">
            <h2 class="section-title">Additional Metrics</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="stat-card">
                    <div class="text-3xl font-bold mono" id="stat-std-rt">-</div>
                    <div class="text-sm opacity-90 mt-1">RT Std Dev (ms)</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold mono" id="stat-mean-reciprocal">-</div>
                    <div class="text-sm opacity-90 mt-1">Mean 1/RT</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold mono" id="stat-go-accuracy">-</div>
                    <div class="text-sm opacity-90 mt-1">GO Accuracy</div>
                </div>
            </div>
            <div id="rt-vs-trial" style="height: 350px;"></div>
        </div>
        
        <!-- Phase Comparison (shown only when "Both" is selected) -->
        <div id="comparison-section" class="card">
            <h2 class="section-title">Phase Comparison</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold mb-3 text-lg">RT Distribution Comparison</h3>
                    <div id="phase-comparison-box" style="height: 300px;"></div>
                </div>
                <div>
                    <h3 class="font-semibold mb-3 text-lg">Accuracy Comparison</h3>
                    <div id="phase-comparison-accuracy" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Raw Data Table -->
        <div class="card">
            <h2 class="section-title">Raw Data</h2>
            <div class="overflow-x-auto">
                <table id="data-table" class="w-full border-collapse">
                    <thead>
                        <tr class="bg-slate-100">
                            <th class="border border-slate-300 px-4 py-2 text-left">Phase</th>
                            <th class="border border-slate-300 px-4 py-2 text-left">Trial</th>
                            <th class="border border-slate-300 px-4 py-2 text-left">Type</th>
                            <th class="border border-slate-300 px-4 py-2 text-left">Correct</th>
                            <th class="border border-slate-300 px-4 py-2 text-left">Error</th>
                            <th class="border border-slate-300 px-4 py-2 text-left">RT (ms)</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="text-center mt-8">
            <button onclick="window.close()" class="bg-white text-purple-700 px-8 py-3 rounded-lg font-semibold hover:bg-purple-50 transition-colors shadow-lg">
                Close Dashboard
            </button>
        </div>
    </div>
    
    <script>
        let allData = [];
        let currentPhase = 'both';
        
        // Listen for data from parent window
        window.addEventListener('message', (event) => {
            if (event.data.type === 'GO_NOGO_DATA') {
                allData = event.data.data;
                initializeDashboard();
            }
        });
        
        // Also check if data is in localStorage (fallback)
        window.addEventListener('load', () => {
            const storedData = localStorage.getItem('goNoGoResults');
            if (storedData && allData.length === 0) {
                allData = JSON.parse(storedData);
                initializeDashboard();
            }
        });
        
        function initializeDashboard() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            updateDashboard();
        }
        
        function setPhase(phase) {
            currentPhase = phase;
            document.querySelectorAll('.phase-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${phase}`).classList.add('active');
            
            // Show/hide comparison section
            document.getElementById('comparison-section').style.display = 
                phase === 'both' ? 'block' : 'none';
            
            updateDashboard();
        }
        
        function filterData() {
            if (currentPhase === 'both') {
                return allData;
            } else if (currentPhase === 'practice') {
                return allData.filter(d => d.phase === 'Practice');
            } else {
                return allData.filter(d => d.phase === 'Real Study');
            }
        }
        
        function updateDashboard() {
            const data = filterData();
            updateStats(data);
            plotRTHistogram(data);
            plotRTBoxplot(data);
            plotRTByTrial(data);
            plotErrorTypes(data);
            plotErrorsByTrial(data);
            plotRTvsTrial(data);
            updateDataTable(data);
            
            if (currentPhase === 'both') {
                plotPhaseComparison();
            }
        }
        
        function updateStats(data) {
            const successfulTrials = data.filter(d => d.isCorrect && d.trialType !== 'pending');
            const goTrials = data.filter(d => d.trialType === 'go' && d.rt !== null && d.rt !== undefined);
            const rts = goTrials.map(d => d.rt);
            
            document.getElementById('stat-total-trials').textContent = 
                [...new Set(data.map(d => `${d.phase}-${d.trialIndex}`))].length;
            
            const accuracy = successfulTrials.length / data.filter(d => d.trialType !== 'pending').length * 100;
            document.getElementById('stat-accuracy').textContent = 
                accuracy.toFixed(1) + '%';
            
            if (rts.length > 0) {
                const mean = rts.reduce((a, b) => a + b, 0) / rts.length;
                document.getElementById('stat-mean-rt').textContent = mean.toFixed(0);
                
                const sorted = [...rts].sort((a, b) => a - b);
                const median = sorted.length % 2 === 0 
                    ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2
                    : sorted[Math.floor(sorted.length / 2)];
                document.getElementById('stat-median-rt').textContent = median.toFixed(0);
                
                const variance = rts.reduce((sum, rt) => sum + Math.pow(rt - mean, 2), 0) / rts.length;
                const std = Math.sqrt(variance);
                document.getElementById('stat-std-rt').textContent = std.toFixed(1);
                
                const meanReciprocal = rts.reduce((sum, rt) => sum + (1000 / rt), 0) / rts.length;
                document.getElementById('stat-mean-reciprocal').textContent = meanReciprocal.toFixed(3);
            } else {
                document.getElementById('stat-mean-rt').textContent = 'N/A';
                document.getElementById('stat-median-rt').textContent = 'N/A';
                document.getElementById('stat-std-rt').textContent = 'N/A';
                document.getElementById('stat-mean-reciprocal').textContent = 'N/A';
            }
            
            const goCorrect = data.filter(d => d.trialType === 'go' && d.isCorrect).length;
            const goTotal = data.filter(d => d.trialType === 'go').length;
            document.getElementById('stat-go-accuracy').textContent = 
                goTotal > 0 ? ((goCorrect / goTotal) * 100).toFixed(1) + '%' : 'N/A';
        }
        
        function plotRTHistogram(data) {
            const rts = data.filter(d => d.trialType === 'go' && d.rt).map(d => d.rt);
            
            if (rts.length === 0) {
                Plotly.newPlot('rt-histogram', [], {title: 'No reaction time data available'});
                return;
            }
            
            const mean = rts.reduce((a, b) => a + b, 0) / rts.length;
            const variance = rts.reduce((sum, rt) => sum + Math.pow(rt - mean, 2), 0) / rts.length;
            const std = Math.sqrt(variance);
            
            // Generate normal curve
            const min = Math.min(...rts);
            const max = Math.max(...rts);
            const xValues = [];
            const yValues = [];
            for (let x = min - std; x <= max + std; x += (max - min) / 100) {
                xValues.push(x);
                const exponent = -Math.pow(x - mean, 2) / (2 * variance);
                yValues.push((1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(exponent) * rts.length * 50);
            }
            
            const trace1 = {
                x: rts,
                type: 'histogram',
                name: 'Reaction Times',
                marker: { color: '#667eea' },
                opacity: 0.7,
                xbins: {
                    size: 100
                }
            };
            
            const trace2 = {
                x: xValues,
                y: yValues,
                type: 'scatter',
                mode: 'lines',
                name: 'Normal Distribution',
                line: { color: '#764ba2', width: 3 }
            };
            
            const layout = {
                title: 'Reaction Time Distribution with Normal Curve',
                xaxis: { 
                    title: 'Reaction Time (ms)',
                    dtick: 100,
                    rangemode: 'tozero'
                },
                yaxis: { 
                    title: 'Frequency',
                    rangemode: 'tozero'
                },
                showlegend: true
            };
            
            Plotly.newPlot('rt-histogram', [trace1, trace2], layout);
        }
        
        function plotRTBoxplot(data) {
            const practiceRTs = data.filter(d => d.phase === 'Practice' && d.trialType === 'go' && d.rt).map(d => d.rt);
            const realRTs = data.filter(d => d.phase === 'Real Study' && d.trialType === 'go' && d.rt).map(d => d.rt);
            
            const traces = [];
            
            if (currentPhase === 'both') {
                if (practiceRTs.length > 0) {
                    traces.push({
                        y: practiceRTs,
                        type: 'box',
                        name: 'Practice',
                        marker: { color: '#667eea' }
                    });
                }
                if (realRTs.length > 0) {
                    traces.push({
                        y: realRTs,
                        type: 'box',
                        name: 'Real Study',
                        marker: { color: '#764ba2' }
                    });
                }
            } else {
                const rts = data.filter(d => d.trialType === 'go' && d.rt).map(d => d.rt);
                if (rts.length > 0) {
                    traces.push({
                        y: rts,
                        type: 'box',
                        name: currentPhase === 'practice' ? 'Practice' : 'Real Study',
                        marker: { color: currentPhase === 'practice' ? '#667eea' : '#764ba2' }
                    });
                }
            }
            
            const layout = {
                title: 'Reaction Time Box Plot',
                yaxis: { 
                    title: 'Reaction Time (ms)',
                    dtick: 100,
                    rangemode: 'tozero'
                }
            };
            
            Plotly.newPlot('rt-boxplot', traces, layout);
        }
        
        function plotRTByTrial(data) {
            const goData = data.filter(d => d.trialType === 'go' && d.rt);
            
            const trace = {
                x: goData.map(d => d.trialIndex),
                y: goData.map(d => d.rt),
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Reaction Time',
                line: { color: '#667eea', width: 2 },
                marker: { size: 8, color: '#764ba2' }
            };
            
            const layout = {
                title: 'Reaction Time Across Trials',
                xaxis: { 
                    title: 'Trial Number',
                    rangemode: 'tozero'
                },
                yaxis: { 
                    title: 'Reaction Time (ms)',
                    dtick: 100,
                    rangemode: 'tozero'
                }
            };
            
            Plotly.newPlot('rt-by-trial', [trace], layout);
        }
        
        function plotErrorTypes(data) {
            const errors = data.filter(d => !d.isCorrect);
            
            if (errors.length === 0) {
                document.getElementById('error-types').innerHTML = 
                    '<div class="flex items-center justify-center h-full text-gray-500 text-lg">No errors recorded</div>';
                return;
            }
            
            const errorCounts = {};
            errors.forEach(d => {
                errorCounts[d.errorCategory] = (errorCounts[d.errorCategory] || 0) + 1;
            });
            
            const trace = {
                labels: Object.keys(errorCounts),
                values: Object.values(errorCounts),
                type: 'pie',
                marker: {
                    colors: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6']
                }
            };
            
            const layout = {
                title: ''
            };
            
            Plotly.newPlot('error-types', [trace], layout);
        }
        
        function plotErrorsByTrial(data) {
            const errors = data.filter(d => !d.isCorrect);
            
            if (errors.length === 0) {
                document.getElementById('errors-by-trial').innerHTML = 
                    '<div class="flex items-center justify-center h-full text-gray-500 text-lg">No errors recorded</div>';
                return;
            }
            
            const trialErrors = {};
            data.forEach(d => {
                if (!trialErrors[d.trialIndex]) {
                    trialErrors[d.trialIndex] = { correct: 0, incorrect: 0 };
                }
                if (d.isCorrect) {
                    trialErrors[d.trialIndex].correct++;
                } else {
                    trialErrors[d.trialIndex].incorrect++;
                }
            });
            
            const trials = Object.keys(trialErrors).sort((a, b) => parseInt(a) - parseInt(b));
            
            const trace = {
                x: trials,
                y: trials.map(t => trialErrors[t].incorrect),
                type: 'bar',
                name: 'Errors',
                marker: { color: '#ef4444' }
            };
            
            const layout = {
                title: '',
                xaxis: { 
                    title: 'Trial Number',
                    rangemode: 'tozero'
                },
                yaxis: { 
                    title: 'Number of Errors',
                    rangemode: 'tozero'
                }
            };
            
            Plotly.newPlot('errors-by-trial', [trace], layout);
        }
        
        function plotRTvsTrial(data) {
            const goData = data.filter(d => d.trialType === 'go' && d.rt);
            
            const trace = {
                x: goData.map(d => d.trialIndex),
                y: goData.map(d => 1000 / d.rt),
                mode: 'markers',
                type: 'scatter',
                name: '1/RT',
                marker: { 
                    size: 10, 
                    color: goData.map(d => d.rt),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: { title: 'RT (ms)' }
                }
            };
            
            const layout = {
                title: 'Reciprocal Reaction Time (Speed) by Trial',
                xaxis: { 
                    title: 'Trial Number',
                    rangemode: 'tozero'
                },
                yaxis: { 
                    title: '1/RT (Higher = Faster)',
                    rangemode: 'tozero'
                }
            };
            
            Plotly.newPlot('rt-vs-trial', [trace], layout);
        }
        
        function plotPhaseComparison() {
            const practiceData = allData.filter(d => d.phase === 'Practice');
            const realData = allData.filter(d => d.phase === 'Real Study');
            
            // Box plot comparison
            const practiceRTs = practiceData.filter(d => d.trialType === 'go' && d.rt).map(d => d.rt);
            const realRTs = realData.filter(d => d.trialType === 'go' && d.rt).map(d => d.rt);
            
            const boxTraces = [];
            if (practiceRTs.length > 0) {
                boxTraces.push({
                    y: practiceRTs,
                    type: 'box',
                    name: 'Practice',
                    marker: { color: '#667eea' }
                });
            }
            if (realRTs.length > 0) {
                boxTraces.push({
                    y: realRTs,
                    type: 'box',
                    name: 'Real Study',
                    marker: { color: '#764ba2' }
                });
            }
            
            Plotly.newPlot('phase-comparison-box', boxTraces, {
                yaxis: { 
                    title: 'Reaction Time (ms)',
                    dtick: 100,
                    rangemode: 'tozero'
                }
            });
            
            // Accuracy comparison
            const practiceCorrect = practiceData.filter(d => d.isCorrect && d.trialType !== 'pending').length;
            const practiceTotal = practiceData.filter(d => d.trialType !== 'pending').length;
            const realCorrect = realData.filter(d => d.isCorrect && d.trialType !== 'pending').length;
            const realTotal = realData.filter(d => d.trialType !== 'pending').length;
            
            const accTrace = {
                x: ['Practice', 'Real Study'],
                y: [
                    practiceTotal > 0 ? (practiceCorrect / practiceTotal) * 100 : 0,
                    realTotal > 0 ? (realCorrect / realTotal) * 100 : 0
                ],
                type: 'bar',
                marker: { color: ['#667eea', '#764ba2'] }
            };
            
            Plotly.newPlot('phase-comparison-accuracy', [accTrace], {
                yaxis: { 
                    title: 'Accuracy (%)',
                    rangemode: 'tozero'
                }
            });
        }
        
        function updateDataTable(data) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            
            data.forEach(d => {
                const row = tbody.insertRow();
                row.className = d.isCorrect ? 'bg-green-50' : 'bg-red-50';
                row.insertCell(0).textContent = d.phase;
                row.insertCell(1).textContent = d.trialIndex;
                row.insertCell(2).textContent = d.trialType;
                row.insertCell(3).textContent = d.isCorrect ? 'Yes' : 'No';
                row.insertCell(4).textContent = d.errorCategory || 'None';
                row.insertCell(5).textContent = d.rt ? d.rt.toFixed(0) : '-';
            });
        }
    </script>
</body>
</html>